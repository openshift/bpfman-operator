# Red Hat catalog transformation tool for bpfman-operator OpenShift catalog
#
# This Containerfile takes upstream bpfman-operator catalog files and
# transforms them for Red Hat distribution by:
# - Updating catalog index with Red Hat bundle and operator image references
# - Setting appropriate timestamps for Red Hat releases
# - Preparing files for OpenShift 4.20 operator registry
#
# To test the Python tool locally without container build:
#   make -C hack/openshift transform-catalog
#
# To build locally within a container:
#   make -C hack/openshift container-transform-catalog

# Build transformation stage using bash tools
ARG BASE_BUILDER_IMAGE_REF=registry.access.redhat.com/ubi9/python-312
FROM ${BASE_BUILDER_IMAGE_REF} AS builder
WORKDIR /usr/src/catalog-transform

USER root

# Install system packages for transformation
# Konflux will automatically handle cachi2 integration for RPM packages
RUN dnf install -y diffutils

COPY --chown=root hack/openshift/ ./hack/openshift/
COPY --chown=root hack/konflux/ ./hack/konflux/
COPY --chown=root catalog /configs/bpfman-operator

# Create copy for diff comparison
RUN cp /configs/bpfman-operator/index.yaml /configs/bpfman-operator/index.yaml.orig

# Transform catalog files in builder stage using bash
RUN hack/openshift/update-catalog.sh \
    --index-file /configs/bpfman-operator/index.yaml \
    --bundle-pullspec "$(cat hack/konflux/images/bpfman-operator-bundle.txt)" \
    --operator-pullspec "$(cat hack/konflux/images/bpfman-operator.txt)"

# Show what changed in catalog file
RUN echo "=== Catalog transformation changes ===" && \
    diff -u /configs/bpfman-operator/index.yaml.orig /configs/bpfman-operator/index.yaml || true && \
    rm -f /configs/bpfman-operator/index.yaml.orig

# The base image is expected to contain
# /bin/opm (with a serve subcommand) and /bin/grpc_health_probe
FROM brew.registry.redhat.io/rh-osbs/openshift-ose-operator-registry-rhel9:v4.20

COPY --from=builder /configs/bpfman-operator /configs/bpfman-operator

# Configure the entrypoint and command
ENTRYPOINT ["/bin/opm"]
CMD ["serve", "/configs", "--cache-dir=/tmp/cache"]

RUN /bin/opm serve /configs --cache-dir=/tmp/cache --cache-only

# Set DC-specific label for the location of the DC root directory
# in the image
LABEL operators.operatorframework.io.index.configs.v1=/configs
